--// Info
print("TuấnAnh Roblox On Top")
print("Welcome to Tuấn Anh Roblox Community")
print("https://www.facebook.com/tuanangg10")

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local FruitList = {"Dragon", "Leopard", "Kitsune", "Venom", "Control", "Spirit", "Dough", "Shadow", "Rumble", "Blizzard", "Gravity", "Portal", "Paw", "Magma", "Light", "Dark", "Ice", "Flame", "Gas", "Yeti"}

local ServerHistory = {}

local FruitRarity = {
    Mythical = {"Dragon", "Leopard", "Kitsune"},
    Legendary = {"Venom", "Control", "Spirit", "Dough", "Shadow", "Rumble", "Blizzard", "Gravity"},
}

local function notify(title, text, duration)
    game.StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5
    })
end

local function findFruit()
    for _, obj in pairs(workspace:GetChildren()) do
        if obj:IsA("Tool") and string.find(obj.Name:lower(), "fruit") then
            return obj
        end
    end
    return nil
end

local function tweenTo(position)
    local hrp = LocalPlayer.Character:WaitForChild("HumanoidRootPart")
    local tween = TweenService:Create(hrp, TweenInfo.new(2, Enum.EasingStyle.Linear), {CFrame = CFrame.new(position)})
    tween:Play()
    tween.Completed:Wait()
end

local function openInventory()
    game:GetService("VirtualInputManager"):SendKeyEvent(true, "M", false, game)
    wait(1)
    game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 0, 0, true, LocalPlayer.PlayerGui.Main.Menu.InventoryButton, 0)
    wait(1)
end

local function isFruitInStorage(fruitName)
    openInventory()
    for _, item in pairs(LocalPlayer.PlayerGui.Main.Inventory.Container.Storage:GetChildren()) do
        if item:IsA("ImageButton") and item:FindFirstChild("ItemName") then
            if string.find(item.ItemName.Text:lower(), fruitName:lower()) then
                return true
            end
        end
    end
    return false
end

local function storeFruit()
    openInventory()
    for _, item in pairs(LocalPlayer.PlayerGui.Main.Inventory.Container.Storage:GetChildren()) do
        if item:IsA("ImageButton") and item:FindFirstChild("ItemName") and string.find(item.ItemName.Text:lower(), "fruit") then
            game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 0, 0, true, item, 0)
            wait(1)
            notify("Đã Lưu Trái", "Trái đã được lưu vào kho đồ!", 5)
            return true
        end
    end
    notify("Lỗi", "Không tìm thấy trái trong kho!", 5)
    return false
end

local function getFruitRarity(fruitName)
    for rarity, list in pairs(FruitRarity) do
        for _, name in pairs(list) do
            if string.find(fruitName:lower(), name:lower()) then
                return rarity
            end
        end
    end
    return "Common"
end

local function getNewServer()
    local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
    for _, server in pairs(servers.data) do
        if server.id ~= game.JobId and not table.find(ServerHistory, server.id) then
            table.insert(ServerHistory, server.id)
            return server.id
        end
    end
    return nil
end

local function hopServer()
    notify("Hop Server", "Đang tìm server mới...", 5)
    local newServer = getNewServer()
    if newServer then
        TeleportService:TeleportToPlaceInstance(game.PlaceId, newServer, LocalPlayer)
    else
        notify("Lỗi", "Không tìm được server mới! Thử lại sau.", 5)
        wait(5)
        hopServer()
    end
end

local function checkForFruit()
    notify("Kiểm Tra Server", "Đang kiểm tra xem có trái không...", 5)
    local foundFruit = nil

    for i = 1, 5 do
        foundFruit = findFruit()
        if foundFruit then break end
        wait(1)
    end

    if foundFruit then
        local fruitName = foundFruit.Name
        local fruitPos = foundFruit.Handle.Position
        local distance = (LocalPlayer.Character.HumanoidRootPart.Position - fruitPos).Magnitude

        notify("Tìm Thấy Trái!", fruitName.." - Cách: "..math.floor(distance).."m", 5)

        -- ESP hiển thị trái (nếu cần)
        local esp = Instance.new("BillboardGui", foundFruit)
        esp.Size = UDim2.new(0, 200, 0, 50)
        esp.Adornee = foundFruit.Handle
        esp.AlwaysOnTop = true

        local textLabel = Instance.new("TextLabel", esp)
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Text = fruitName.." - "..math.floor(distance).."m"
        textLabel.TextColor3 = Color3.fromRGB(255, 85, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextStrokeTransparency = 0

        tweenTo(fruitPos)
        wait(0.5)

        LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):EquipTool(foundFruit)

        local rarity = getFruitRarity(fruitName)

        if rarity == "Mythical" or rarity == "Legendary" then
            if isFruitInStorage(fruitName) then
                notify("Trái Hiếm Đã Có", "Giữ trái này không hop!", 5)
                return
            else
                storeFruit()
                hopServer()
            end
        else
            storeFruit()
            hopServer()
        end
    else
        notify("Không Có Trái!", "Đợi 3s rồi hop server.", 5)
        wait(3)
        hopServer()
    end
end

--// Start
checkForFruit()
